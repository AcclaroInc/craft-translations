{% import '_includes/forms' as forms %}

{% do view.registerAssetBundle("acclaro\\translations\\assetbundles\\FilePreviewAssets") %}

<div id="files" class="{% if not selectedTab|default(null) %} hidden {% endif %}">
	<div class="field">
		<div class="heading">
			<label id="files-label">
				Files
			</label>
			<div class="btngroup submit ml-auto">
				<div class="translations-loader hidden" style="margin-right:-30px"></div>

				<div id='file-actions' class='btngroup flex flex-nowrap noClick disabled pr-10px'>
					<div class="btn menubtn" data-icon='settings' title='Actions' id='file-actions-menu-icon'></div>
				</div>

				<input type="button" id="review" class="btn submit disabled form-submit border-left-radius-5px"
					disabled="disabled" value="{{ 'Review changes'|t }}">
			</div>
		</div>
	</div>
	<div class="input ltr scroll-x-auto">
		{% if not order.isPending %}
			{% set fileCheckboxProp = 'disabled' %}
			<table class="data fullwidth" dir="ltr">
				<thead>
					<tr>
						{% if order.canEnableFilesCheckboxes %}
							{% set fileCheckboxProp = '' %}
						{% endif %}
						<td class="thin checkbox-cell translations-checkbox-cell select-all-checkbox">
							<input class="checkbox hidden" id="file-0" type="checkbox" {{ fileCheckboxProp }}>
							<label class="checkbox" for="file-0"></label>
						</td>
						<th>{{ 'Title'|t }}</th>
						<th>{{ 'Target Site'|t }}</th>
						<th>{{ 'Section'|t }}</th>
						<th>{{ 'Last Delivery'|t }}</th>
						<th>{{ 'Status'|t }}</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					{% for file in order.files %}
						{% set element = file.element %}
						<tr data-word-count="{{ elementWordCounts[file.elementId] }}" data-element-id="{{ file.elementId }}" class="diff-clone" data-file-id="{{ file.id }}">

							<td class="thin checkbox-cell translations-checkbox-cell file">
								{% if file.isInProgress or file.isComplete or file.isReviewReady or file.isPublished %}
									<input class="checkbox hidden" data-element="{{ file.elementId }}" id="file-{{ file.id }}" type="checkbox" name="files[]" value="{{ file.id }}"/>
								{% else %}
									<input class="checkbox hidden" data-element="{{ file.elementId }}" id="file-{{ file.id }}" type="checkbox" name="files[]" value="{{ file.id }}" disabled="disabled"/>
								{% endif %}
								<label class="checkbox" for="file-{{ file.id }}"></label>
							</td>

							<td>
								<div id="{{ "filePreview-"~ file.id }}">
									<div class="elements">
										<div class="element small" title="{{ file.uiLabel ~" - " ~siteObjects[file.targetSite].name }}" data-id="{{ file.elementId }}" data-editable="" data-site-id={{ file.targetSite }} {% if file.isComplete %} data-draft-id={{ file.draftId }} {% endif %}>
											<div class="label">
												<span class="title">{{ file.uiLabel }}</span>
											</div>
										</div>
										{% set sourceUpdated = file.elementId in isSourceChanged %}
										{% set targetUpdated = order.trackTargetChanges and file.hasTmMisAlignments and not file.isNew and not file.isModified %}

										{# Ignore target changes for api order that are completed #}
										{% if not order.hasDefaultTranslator and (order.isReviewReady or order.isComplete or order.isPublished) %}
											{% set targetUpdated = false %}
										{% endif %}

										{# Create Preview for each target entry #}
										{% if file.hasPreview %}
											{% set fileId = 'file_' ~ file.id %}

											<a id="{{ fileId }}" data-icon="world" title="{{ 'Visit webpage'|t }}"></a>

											{% js %}
												new Craft.Translations.FilePreview($('#{{fileId}}'), {{ file.filePreviewSettings|json_encode|raw }});
											{% endjs %}
										{% endif %}

										{% if canUpdateFiles and not file.isPublished and (sourceUpdated or targetUpdated) %}
											<span class="warning order-warning font-size-15" data-icon="alert">
												{% if sourceUpdated %}
													<li> {{ 'Source entry content has been modified since order was created.' }} </li>
												{% endif %}

												{% if targetUpdated %}
													<li> {{ 'Target entry content has been modified since order was created.' }} </li>
												{% endif %}
											</span>
										{% endif %}
									</div>
								</div>
								{% js %}
									new Craft.Translations.EntryPreview({{ file.entryPreviewSettings|json_encode|raw }});
								{% endjs %}
							</td>

							<td>
								<table>
									<tr>
										{% if siteObjects[file.targetSite] is defined %}
											<td>
												{{siteObjects[file.targetSite].name}} ({{ siteObjects[file.targetSite].language }})
											</td>
										{% else %}
											<td style="color:red;">
												{{ "Deleted" }}
											</td>
										{% endif %}
									</tr>
								</table>
							</td>

							<td>
								{% if element.className == constant('acclaro\\translations\\Constants::CLASS_GLOBAL_SET') %}
									{{ 'Globals' }}
								{% elseif element.className == constant('acclaro\\translations\\Constants::CLASS_CATEGORY') %}
									{{ 'Category' }}
								{% elseif element.className == constant('acclaro\\translations\\Constants::CLASS_ASSET') %}
									{{ 'Asset' }}
								{% else %}
									{{ element.section.name }}
								{% endif %}

							</td>

							<td>
								<table>
									<tr>
										<td>
										{% if file.isReviewReady or file.isComplete or file.isPublished %}
											{{ file.dateDelivered ? file.dateDelivered|date('M j, Y g:i a') : '--' }}
										{% else %}
											{{ '--' }}
										{% endif %}
										</td>
									</tr>
								</table>
							</td>

							<td>
								<table>
									<tr>
										<td class="inline-flex align-center">
											<span class="status {{ file.statusColor }}"
												style="position: absolute;left: -10px;"
												data-status="{{ file.hasSourceTargetDiff }}">
												</span>{{ file.statusLabel }}
										</td>
									</tr>
								</table>
							</td>
							<td><table><thead><th class="bg-none icon ordered desc orderable hidden"><button type="button"></button></th></thead></table></td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		{% else %}
			No files
		{% endif %}
	</div>
</div>
